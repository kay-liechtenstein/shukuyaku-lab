<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¸®ç´„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            height: 140vh;
            background-image: url('bg1.jpg'); /* ç”»åƒã‚’èƒŒæ™¯ã¨ã—ã¦è¨­å®š */
            background-size: cover; /* ç”»åƒã‚’å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆ */
            background-position: center; /* ç”»åƒã®ä¸­å¤®æƒãˆ */
            background-repeat: no-repeat; /* ç¹°ã‚Šè¿”ã—ã‚’ç„¡åŠ¹åŒ– */
        }

        #summaryRate {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        #targetRate {
            font-size: 1rem;
            font-weight: normal;
            color: #555;
            text-align: center;
            margin-bottom: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            width: 100%;
            align-items: flex-start;
        }

        .column {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
            word-wrap: break-word;
            box-sizing: border-box;
        }

        .highlight {
            background-color: turquoise;
        }

        .output-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .output-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 0;
            display: flex;
            align-items: center;
        }

        .copyButton {
            margin-left: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #007bff;
        }

        .copyButton:hover {
            color: #0056b3;
        }

        .output, #leftColumn {
            font-size: 1rem;
            padding: 10px;
            white-space: pre-wrap;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            min-height: 150px;
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="summaryRate">ç¾åœ¨ã®ç¸®ç´„ç‡: 0.00%</div>
    <div id="targetRate"></div>
    <div class="container">
        <div class="column">
            <div class="output-wrapper">
                <h2 class="output-title">ç¸®ç´„ã«ä½¿ã†æ–‡å­—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ</h2>
            </div>
            <div id="leftColumn" contenteditable="false">
                </div>
        </div>
        <div class="column">
            <div class="output-wrapper">
                <h2 class="output-title">ç¸®ç´„å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ</h2>
                <button class="copyButton" onclick="copyToClipboard()">ğŸ“‹</button>
            </div>
            <div class="output" id="highlightedText"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const inputText = sessionStorage.getItem('inputText');
        const targetRateValue = sessionStorage.getItem('targetRate');

        const originalText = inputText || '';
        const originalTextLength = originalText.replace(/\s+/g, '').length;

        const leftColumn = document.getElementById('leftColumn');
        const targetRateDisplay = document.getElementById('targetRate');
        const highlightedTextDisplay = document.getElementById('highlightedText');
        const summaryRateDisplay = document.getElementById('summaryRate');

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ç¯„å›²ã‚’ {start, end} ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—ã¨ã—ã¦æ ¼ç´
        let highlightRanges = [];

        if (targetRateValue) {
            targetRateDisplay.textContent = `ç›®æ¨™ã®ç¸®ç´„ç‡: ${targetRateValue}%`;
        }

        // DOMã®é¸æŠç¯„å›²ã‚’æ–‡å­—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function getSelectionCharacterOffsetWithin(element) {
            let start = 0;
            let end = 0;
            const selection = window.getSelection();

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(element);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);
                start = preSelectionRange.toString().length;
                end = start + range.toString().length;
            }
            return { start, end };
        }

        // é¸æŠã«åŸºã¥ã„ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã¾ãŸã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
        leftColumn.addEventListener('mouseup', () => {
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.toString().trim()) {
                return;
            }

            const { start, end } = getSelectionCharacterOffsetWithin(leftColumn);
            if (start === end) { // å®Ÿéš›ã«ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ
                return;
            }

            // é¸æŠã•ã‚ŒãŸç¯„å›²ãŒæ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå†…ã«å®Œå…¨ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            let isUnhighlight = false;
            for (let i = 0; i < highlightRanges.length; i++) {
                const hr = highlightRanges[i];
                if (start >= hr.start && end <= hr.end) {
                    isUnhighlight = true;
                    break;
                }
            }

            if (isUnhighlight) {
                unhighlightSelection(start, end);
            } else {
                highlightSelection(start, end);
            }

            renderTextWithHighlights();
            updateHighlightedText();
            updateSummaryRate();
            selection.removeAllRanges(); // å‡¦ç†å¾Œã«é¸æŠã‚’ã‚¯ãƒªã‚¢
        });

        function highlightSelection(newStart, newEnd) {
            // æ–°ã—ã„ç¯„å›²ã‚’è¿½åŠ ã—ã€ã™ã¹ã¦ã®ç¯„å›²ã‚’çµåˆ/ã‚½ãƒ¼ãƒˆã™ã‚‹
            highlightRanges.push({ start: newStart, end: newEnd });
            mergeAndSortHighlights();
        }

        function unhighlightSelection(unStart, unEnd) {
            let newHighlightRanges = [];
            highlightRanges.forEach(hr => {
                // ã‚±ãƒ¼ã‚¹1: ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸç¯„å›²ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ç¯„å›²ã®å®Œå…¨ã«å¤–å´ã«ã‚ã‚‹
                if (hr.end <= unStart || hr.start >= unEnd) {
                    newHighlightRanges.push(hr);
                }
                // ã‚±ãƒ¼ã‚¹2: ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸç¯„å›²ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ç¯„å›²ã‚’å®Œå…¨ã«è¦†ã£ã¦ã„ã‚‹
                else if (hr.start < unStart && hr.end > unEnd) {
                    newHighlightRanges.push({ start: hr.start, end: unStart });
                    newHighlightRanges.push({ start: unEnd, end: hr.end });
                }
                // ã‚±ãƒ¼ã‚¹3: ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ç¯„å›²ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆå†…ã§å§‹ã¾ã‚Šã€å¤–å´ã«åºƒãŒã‚‹
                else if (hr.start < unStart && hr.end <= unEnd) {
                    newHighlightRanges.push({ start: hr.start, end: unStart });
                }
                // ã‚±ãƒ¼ã‚¹4: ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ç¯„å›²ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆå†…ã§çµ‚ã‚ã‚Šã€ä»¥å‰ã«å§‹ã¾ã‚‹
                else if (hr.start >= unStart && hr.end > unEnd) {
                    newHighlightRanges.push({ start: unEnd, end: hr.end });
                }
                // ã‚±ãƒ¼ã‚¹5: ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸç¯„å›²ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤ç¯„å›²å†…ã«å®Œå…¨ã«å«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆå‰Šé™¤ã™ã‚‹ï¼‰
                // ã“ã®ã‚±ãƒ¼ã‚¹ã¯ã€'hr'ã‚’newHighlightRangesã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãªã„ã“ã¨ã§æš—é»™çš„ã«å‡¦ç†ã•ã‚Œã‚‹
            });
            highlightRanges = newHighlightRanges;
            mergeAndSortHighlights(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤å¾Œã«å†åº¦çµåˆ
        }

        function mergeAndSortHighlights() {
            if (highlightRanges.length === 0) {
                return;
            }

            // é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚½ãƒ¼ãƒˆ
            highlightRanges.sort((a, b) => a.start - b.start);

            const merged = [];
            let current = highlightRanges[0];

            for (let i = 1; i < highlightRanges.length; i++) {
                const next = highlightRanges[i];
                // ç¾åœ¨ã®ç¯„å›²ãŒæ¬¡ã®ç¯„å›²ã¨é‡è¤‡ã¾ãŸã¯éš£æ¥ã—ã¦ã„ã‚‹å ´åˆã€çµåˆã™ã‚‹
                if (current.end >= next.start) {
                    current.end = Math.max(current.end, next.end);
                } else {
                    merged.push(current);
                    current = next;
                }
            }
            merged.push(current); // æœ€å¾Œã«çµåˆã•ã‚ŒãŸç¯„å›²ã‚’è¿½åŠ 
            highlightRanges = merged;
        }

        function renderTextWithHighlights() {
            leftColumn.innerHTML = ''; // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            let currentIndex = 0;

            if (!originalText) {
                leftColumn.innerHTML = '<p>ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            highlightRanges.forEach(hr => {
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å‰ã«ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ  (å­˜åœ¨ã™ã‚‹å ´åˆ)
                if (hr.start > currentIndex) {
                    leftColumn.appendChild(document.createTextNode(originalText.substring(currentIndex, hr.start)));
                }

                // ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
                const span = document.createElement('span');
                span.className = 'highlight';
                span.textContent = originalText.substring(hr.start, hr.end);
                leftColumn.appendChild(span);

                currentIndex = hr.end;
            });

            // æœ€å¾Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å¾Œã«æ®‹ã£ã¦ã„ã‚‹ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
            if (currentIndex < originalText.length) {
                leftColumn.appendChild(document.createTextNode(originalText.substring(currentIndex)));
            }
        }

        function updateHighlightedText() {
            let selectedChars = '';
            highlightRanges.forEach(hr => {
                selectedChars += originalText.substring(hr.start, hr.end);
            });
            highlightedTextDisplay.textContent = selectedChars;
        }

        function updateSummaryRate() {
            let highlightedLength = 0;
            highlightRanges.forEach(hr => {
                highlightedLength += originalText.substring(hr.start, hr.end).replace(/\s+/g, '').length;
            });

            const summaryPercentage = originalTextLength > 0
                ? ((highlightedLength / originalTextLength) * 100).toFixed(2)
                : 0;

            summaryRateDisplay.textContent = `ç¾åœ¨ã®ç¸®ç´„ç‡: ${summaryPercentage}%`;

            if (targetRateValue) {
                const targetRateNum = parseFloat(targetRateValue);
                const lowerBound = targetRateNum - 5;
                const upperBound = targetRateNum + 5;

                summaryRateDisplay.style.color = summaryPercentage >= lowerBound && summaryPercentage <= upperBound ? 'deeppink' : '#333';
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('highlightedText').textContent;
            navigator.clipboard.writeText(text)
                .then(() => {
                    Swal.fire({
                        text: 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                })
                .catch(() => {
                    Swal.fire({
                        text: 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
        }

        // åˆæœŸè¡¨ç¤ºã¨æ›´æ–°
        renderTextWithHighlights();
        updateHighlightedText();
        updateSummaryRate();
    </script>
</body>
</html>